name: 'Chef InSpec Compliance Scan'

on:
  workflow_dispatch:

jobs:
  inspec-scan-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Check out the repository code (your InSpec profile)
      - name: Checkout InSpec Profile from Repository
        uses: actions/checkout@v4
      
      # Step 2: Install Chef InSpec
      - name: Install Chef InSpec
        run: |
          curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P inspec
          inspec version
      
      # Step 3: Run the InSpec scan on the local runner
      - name: Run InSpec Scan
        run: |
          inspec exec './ssh-baseline' \
            --target local:// \
            --reporter cli json:inspec-report.json
        continue-on-error: true
      
      # Step 4: Store the scan report as a downloadable artifact
      # This is for archival and manual inspection. It runs even if other steps fail.
      - name: Upload InSpec Report as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: inspec-scan-report
          path: inspec-report.json
      
      # Step 5: Push the scan results to DefectDojo
      # Using ivanamat/defectdojo-import-scan action
      - name: Upload Results to DefectDojo
        if: always()
        uses: ivanamat/defectdojo-import-scan@v1
        with:
          token: ${{ secrets.DEFECTDOJO_API_KEY }}
          defectdojo_url: ${{ secrets.DEFECTDOJO_URL }}
          file: inspec-report.json
          scan_type: 'Chef Inspec Scan'
          engagement: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}
          # Optional: Set to true to create the engagement if it doesn't exist
          # auto_create_context: true
          # Optional: Close old findings
          # close_old_findings: true
