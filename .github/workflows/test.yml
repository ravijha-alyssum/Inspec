name: 'Chef InSpec Compliance New'
on:
  workflow_dispatch:
  
jobs:
  inspec-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout InSpec Profile from Repository
        uses: actions/checkout@v4
      
      - name: Install Chef Habitat
        run: |
          curl https://raw.githubusercontent.com/habitat-sh/habitat/main/components/hab/install.sh | sudo bash
        env:
          HAB_LICENSE: accept-no-persist
          
      - name: Accept Habitat License
        run: |
          echo "yes" | sudo hab license accept
          
      - name: Install Chef InSpec
        run: |
          sudo hab pkg install chef/inspec --channel stable --binlink --force
          inspec --version
      
      - name: Run InSpec Scan
        env:
          CHEF_LICENSE: accept-silent
        run: |
          inspec exec ./ssh-baseline \
            --target local:// \
            --reporter cli json:inspec-report.json
        continue-on-error: true
      
      - name: Transform InSpec to DefectDojo Format
        if: always()
        run: |
          # Use the enhanced transformation script from above
          cat > transform-inspec.py << 'EOF'
          # [Insert the complete transformation script from above]
          EOF
          python3 transform-inspec.py
      
      - name: Upload to DefectDojo
        if: always()
        run: |
          curl -v -X POST "${{ secrets.DEFECTDOJO_URL }}/api/v2/import-scan/" \
            -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" \
            -F "file=@defectdojo-findings.json" \
            -F "scan_type=Generic Findings Import" \
            -F "engagement_name=ssh-baseline-ci" \
            -F "product_name=MyProduct" \
            -F "scan_date=$(date +%Y-%m-%d)" \
            -F "active=true" \
            -F "verified=false"
      
      - name: Upload Reports as Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: inspec-scan-reports
          path: |
            inspec-report.json
            defectdojo-findings.json
